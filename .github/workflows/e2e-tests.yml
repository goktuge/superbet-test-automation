name: E2E Tests

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression

env:
  INFLUX_URL: ${{ secrets.INFLUX_CLOUD_URL }}
  INFLUX_TOKEN: ${{ secrets.INFLUX_CLOUD_TOKEN }}
  INFLUX_ORG: ${{ secrets.INFLUX_CLOUD_ORG }}
  INFLUX_BUCKET: test-metrics

jobs:
  smoke-tests:
    name: Smoke Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run smoke tests
        run: npx playwright test tests/smoke --project=${{ matrix.browser }}
        continue-on-error: true
        env:
          ENV: staging
          BASE_URL: ${{ secrets.STAGING_URL || 'https://superbet.ro' }}
          HEADLESS: true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.browser }}
          path: |
            allure-results/
            test-results/

  regression-tests:
    name: Regression Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run regression tests
        run: npx playwright test tests --project=${{ matrix.browser }}
        continue-on-error: true
        env:
          ENV: prod
          BASE_URL: ${{ secrets.PROD_URL || 'https://superbet.ro' }}
          HEADLESS: true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.browser }}
          path: |
            allure-results/
            test-results/

  manual-trigger:
    name: Manual Test Run - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run tests
        run: |
          if [ "${{ github.event.inputs.test_type }}" == "smoke" ]; then
            npx playwright test tests/smoke --project=${{ matrix.browser }}
          else
            npx playwright test tests --project=${{ matrix.browser }}
          fi
        continue-on-error: true
        env:
          ENV: ${{ github.event.inputs.environment }}
          BASE_URL: ${{ secrets.STAGING_URL || 'https://superbet.ro' }}
          HEADLESS: true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-artifacts-${{ matrix.browser }}
          path: |
            allure-results/
            test-results/

  report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, regression-tests, manual-trigger]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Checkout gh-pages (existing report history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Prepare Allure results and attachments
        run: |
          mkdir -p allure-results test-results
          if [ -d artifacts ]; then
            for dir in artifacts/test-artifacts-*; do
              [ -d "$dir" ] || continue
              if [ -d "$dir/allure-results" ]; then
                for f in "$dir/allure-results"/*.json; do
                  [ -f "$f" ] && cp -n "$f" allure-results/ 2>/dev/null || true
                done
              fi
              if [ -d "$dir/test-results" ]; then
                cp -r "$dir/test-results"/* test-results/ 2>/dev/null || true
              fi
            done
          fi

      - name: Generate Allure report
        run: npx allure generate allure-results --clean -o allure-report
        continue-on-error: true

      - name: Restore Allure history (trend from previous run)
        run: |
          PREV=$(for d in gh-pages/[0-9]*/; do [ -d "$d" ] && basename "$d"; done 2>/dev/null | sort -n | tail -1)
          if [ -n "$PREV" ] && [ -d "gh-pages/$PREV/history" ]; then
            cp -r "gh-pages/$PREV/history" allure-report/
          fi
        continue-on-error: true

      - name: Build publish dir (last 20 runs, numbered folders)
        run: |
          KEEP=20
          PUBLISH=publish
          mkdir -p "$PUBLISH"

          # Next run number = max(existing numbered dirs) + 1, or 1
          NEXT=1
          if [ -d gh-pages ]; then
            for d in gh-pages/*/; do
              n=$(basename "$d")
              case "$n" in ([0-9]*) [ "$n" -gt "$NEXT" ] 2>/dev/null && NEXT=$n ;; esac
            done
            [ "$NEXT" -ge 1 ] 2>/dev/null && NEXT=$((NEXT + 1))
          fi

          # Copy existing numbered report folders from gh-pages into publish
          for d in gh-pages/*/; do
            [ -d "$d" ] || continue
            n=$(basename "$d")
            case "$n" in ([0-9]*) cp -r "$d" "$PUBLISH/$n" ;; esac
          done

          # Add this run as the next number
          if [ -d allure-report ] && [ -n "$(ls -A allure-report 2>/dev/null)" ]; then
            cp -r allure-report "$PUBLISH/$NEXT"
          fi

          # Keep only the last KEEP runs (highest numbers)
          cd "$PUBLISH"
          for d in [0-9]*/; do
            [ -d "$d" ] || continue
            echo "$(basename "$d")"
          done | sort -n | head -n -"$KEEP" | while read -r old; do
            rm -rf "$old"
          done
          cd ..

          # Index: redirect to latest (relative for project Pages)
          LATEST=$(cd "$PUBLISH" && for d in [0-9]*/; do [ -d "$d" ] && basename "$d"; done | sort -n | tail -1)
          if [ -n "$LATEST" ]; then
            echo "<!DOCTYPE html><html><head><meta http-equiv=\"refresh\" content=\"0;url=$LATEST/\" /><script>location.href='$LATEST/';</script></head><body><p>Redirecting to <a href=\"$LATEST/\">latest report ($LATEST)</a>...</p></body></html>" > "$PUBLISH/index.html"
          fi

          echo "NEXT_RUN=$NEXT" >> $GITHUB_ENV
          echo "LATEST=$LATEST" >> $GITHUB_ENV
          echo "Published run number: $NEXT (latest: $LATEST)"

      - name: Deploy to GH Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: publish
          publish_branch: gh-pages
        if: success() || failure()
